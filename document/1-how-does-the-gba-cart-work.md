# GBA游戏卡是怎么运作的?

## 前言

## 一、游戏卡的结构

### 卡槽总线 - 定义

32Pin(1.5mm)的卡槽总线定义如下:

| 引脚 | 名称     | 方向 | 说明                                                         |
|------|----------|------|------------------------------------------------------------|
| 1    | VDD      | O    | 电源 3.3V DC                                                 |
| 2    | PHI      | O    | 系统时钟（可选无、4.19MHz、8.38MHz、16.78MHz）             |
| 3    | /WR      | O    | 写选择；锁存的地址将在/RD，或/WR信号的上升沿递增           |
| 4    | /RD      | O    | 读选择；或/WR信号的上升沿递增                               |
| 5    | /CS      | O    | ROM芯片选择；地址 A0..A15 将在下降沿被锁存                 |
| 6-21 | AD0-15   | I/O  | 低位16位地址 和/或 16位ROM数据（见下文）                   |
| 22-29| A16-23   | I/O  | 高位8位ROM地址 或 8位SRAM数据（见下文）                   |
| 30   | /CS2     | O    | SRAM芯片选择                                                 |
| 31   | /REQ     | I    | 中断请求 (/IREQ) 或 DMA请求 (/DREQ)                         |
| 32   | GND      | O    | 地 0V                                                        |

当访问游戏卡SRAM时，16位地址通过AD0-AD15输出，然后8位数据通过A16-A23传输。

当访问游戏卡ROM时，24位地址通过AD0-AD15和A16-A23输出，然后16位数据通过AD0-AD15传输。

24位地址由实际的25位内存地址（字节步进）除以二（半字步进）形成。

要点概括:
- AD0-AD15 低16位地址
    - 在WR或者RD信号上升沿递增
- ROM读写
    - 通过CS使能ROM芯片, 通过AD0-AD15和A16-A23传输地址, 通过AD0-AD15传输数据
    - AD0-AD15同时用于ROM地址和数据传输, 所以CS下降沿时, 地址会被游戏卡锁存, 以便数据传输
    - 锁存的地址 + A16-A23 组成24位地址, 24位地址用于ROM, 每个地址对应16bit, 一共有256Mbit的地址空间
- RAM读写
    - 通过CS2使能SRAM芯片, 通过AD0-AD15传输地址, 通过A16-A23传输数据
    - 16位地址直接用于SRAM(RAM读写不需要锁存), 每个地址对应8bit, 一共有512Kbit的地址空间 (Bank Switching我们后面再讨论)

#### 卡槽总线 - 时序

通过卡带读写数据的时序如下:

| 区域       | 总线  | 读取   | 写入   | 周期数     |
|------------|-------|--------|--------|----------|
| 游戏卡Flash | 16位  | 8/16/32位 | 16/32位 | 5/5/8 \*\*/\*\*\* |
| 游戏卡ROM   | 16位  | 8/16/32位 | N/A     | 5/5/8 \*\*/\*\*\* |
| 游戏卡SRAM   | 8位   | 8位    | 8位    | 5 \*\*   |

注意事项：
```
  *   如果GBA在访问视频内存的同时访问，则额外增加1个周期。
  **  默认等待状态设置，请参阅系统控制章节。
  *** 顺序访问和非顺序访问的单独定时。
  一个周期大约等于59.59ns（即16.78MHz的时钟）。
```

#### 卡槽总线 - 总结

显然并没有一款量产型片能直接满足卡槽读写协议。

考虑到时序要求以及功耗要求，我们可以通过CPLD/FPGA来实现这个逻辑电路。

- 地址锁存、自增
- 把拼接的24位地址传递给ROM芯片
- 实现Flash ROM的存档备份以及Bank Switching(1Mbit存档)
- 实现FRAM的1Mbit存档备份, 通过识别Flash ROM Bank Switching命令来实现
- 其他高级功能，比如振动反馈、实时时钟等

### ROM芯片

ROM芯片内存储了GBA游戏的程序和数据，由于上述的限制，ROM芯片的容量最大为256Mbit。

存储ROM的芯片一般选择Parallel NOR Flash，方便开发，但成本较高。

### SRAM芯片

SRAM芯片内存储了游戏的存档数据，由于上述的限制，SRAM芯片的容量最大为512Kbit。

特殊的是，一些GBA游戏使用了Bank Switching技术，这种技术可以让游戏卡的SRAM容量扩展到1Mbit。

p.s. 高端的游戏卡会使用FRAM芯片代替SRAM，来确保断电数据不丢失。

## 二、地址映射

### 地址映射

| 地址范围    | 功能       | 大小     | 说明 |
|------------|-----------|---------|------|
| 08000000-09FFFFFF | ROM/FlashROM | 32MB | ROM/FlashROM的地址空间(等待状态0) |
| 0A000000-0BFFFFFF | ROM/FlashROM | 32MB | ROM/FlashROM的地址空间(等待状态1) |
| 0C000000-0DFFFFFF | ROM/FlashROM | 32MB | ROM/FlashROM的地址空间(等待状态2) |
| 0E000000-0E00FFFF | SRAM        | 64KB | SRAM的地址空间(8位总线) |
| 0E010000-0FFFFFFF | 未使用      | 未知  | 未使用的地址空间 |


### 一些特殊操作


#### Flash ROM Bank Switching

```
  [E005555h]=AAh, [E002AAAh]=55h, [E005555h]=B0h  (select bank command)
  [E000000h]=bnk                                  (write bank number 0..1)
```

## 三、特殊通讯

除了ROM和SRAM芯片，一些特殊的外设和功能也会通过卡槽总线进行通讯，后续再完善这部分。

### 实时时钟
### 振动反馈
### 太阳传感器
### 其他

GBA游戏卡还有一些外设，比如实时时钟、振动反馈、太阳传感器等。


- 参考文献: [GBATEK](http://problemkaputt.de/gbatek.htm)